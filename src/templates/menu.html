<!-- Macro is a templating function. It is rendered into the HTML below with searchResults(). -->
{% macro searchResults () %}
  <!-- TODO: Sort the layout based on the IDs. -->
  <a-entity id="searchResultList"
            bind-for="for: item; in: searchResultsPage; key: id; template: #searchResultTemplate; updateInPlace: true; pool: 6; delay: 25"
            layout="type: box; columns: 1; marginRow: -0.2; orderAttribute: data-index"
            search-result-list
            position="0 0.644 0"></a-entity>

  <!-- All search result text merged and spaced out. -->
  <a-entity
    id="searchSongNameTexts"
    mixin="font"
    bind__text="value: search.songNameTexts"
    render-order="menutext"
    text="baseline: top; align: left; color: #FAFAFA; wrapCount: 28; lineHeight: 130"
    position="0.181 0.51943 0.001">
  </a-entity>
  <a-entity
    id="searchSongSubNameTexts"
    mixin="font"
    bind__text="value: search.songSubNameTexts"
    render-order="menutext"
    text="baseline: top; align: left; color: {{ COLORS.BLUE }}; wrapCount: 42; lineHeight: 190"
    position="0.181 0.445 0.001">
  </a-entity>

  <a-entity
    id="searchThumbnailImages"
    bind__search-thumbnail-atlas="dummyUpdater: search.songSubNameTexts"
    bind__visible="searchResultsPage.length > 0"
    geometry="primitive: plane; buffer: false; width: 0.2; height: 1.2"
    dynamic-texture-atlas="canvasId: thumbnailAtlasMap; canvasWidth: 64; canvasHeight: 512; numColumns: 1; numRows: 6"
    material="shader: flat; transparent: true"
    render-order="menubutton"
    position="-0.45 0.0146 0.002"></a-entity>

  <a-mixin id="searchPageButton"
    animation__mouseenter="property: components.slice9.material.opacity; from: 0; to: 0.3; startEvents: mouseenter; pauseEvents: mouseleave; dur: 150"
    animation__mouseleave="property: components.slice9.material.opacity; from: 0.3; to: 0; startEvents: mouseleave; pauseEvents: mouseenter; dur: 150"
    mixin="slice"
    raycaster-target="width: 1; height: 0.32"
    render-order="menubutton"
    slice9="width: 0.8; color: {{ COLORS.UI_ACCENT }}; height: 0.130; padding: 0.03; opacity: 0"></a-mixin>

  <a-entity
    id="searchPrevPage"
    mixin="searchPageButton"
    slice9="color: {{ COLORS.RED }}"
    bind__visible-raycastable="search.hasPrev && menuActive"
    raycaster-target="bindToggle: search.hasNext && menuActive; position: 0 0.08 0"
    position="-0 0.69 0.01"
    proxy-event="event: click; to: a-scene; as: searchprevpage; captureBubbles: true">
    <a-entity id="prevArrow" geometry="primitive: plane; width: 0.12; height: 0.12" material="shader: flat; src: #downIconImg; transparent: true; color: {{ COLORS.RED }}" rotation="0 0 180" position="0 0 -0.001"></a-entity>
  </a-entity>

  <a-entity
    id="searchNextPage"
    mixin="searchPageButton"
    raycaster-target="bindToggle: search.hasNext && menuActive; position: 0 -0.08 0"
    position="-0 -0.674 0.01"
    proxy-event="event: click; to: a-scene; as: searchnextpage; captureBubbles: true"
    bind__visible="search.hasNext">
    <a-entity id="nextArrow" geometry="primitive: plane; width: 0.12; height: 0.12" material="shader: flat; src: #downIconImg; transparent: true; color: {{ COLORS.BLUE }}" position="0 0 -0.001"></a-entity>
  </a-entity>
{% endmacro %}

{% raw %}
  <template id="searchResultTemplate">
    <a-entity
      class="searchResult"
      bind-item__data-id="item.id"
      bind-item__data-index="item.index"
      bind-item__song-preview="challengeId: item.id; previewStartTime: item.previewStartTime">
      <a-entity
        class="searchResultBackground"
        bind-item__active-item="active: menuSelectedChallenge.id === item.id"
        bind-item__animation__mouseenter="enabled: menuSelectedChallenge.id !== item.id"
        bind-item__animation__mouseleave="enabled: menuSelectedChallenge.id !== item.id"
        bind-toggle__raycastable="menuActive && !introActive"
        animation__mouseenter="property: components.material.material.opacity; to: 0.4; startEvents: mouseenter; pauseEvents: mouseleave; dur: 75; delay: 1"
        animation__mouseleave="property: components.material.material.opacity; to: 0.0; startEvents: mouseleave; pauseEvents: mouseenter; dur: 75"
        geometry="primitive: plane; width: 1.1; height: 0.2"
        material="shader: flat; transparent: true; opacity: 0.0; src: #selectedImg"
        position="0 -0.13 -0.002"
        play-sound="event: mouseenter; sound: #hoverSound; volume: 0.03"
        render-order="menuitem"></a-entity>
      </a-entity>
    </a-entity>
  </template>
{% endraw %}

<!-- Menu container begins here. -->
<a-entity
  id="menu"
  bind__visible="menuActive"
  position="0 1.4 -2.3"
  animation__position="property: object3D.position.z; to: -2; dur: 1500; easing: easeInOutCubic; delay: 300; startEvents: startgame">

  <a-entity
    id="menuBackground"
    bind__animation__midsection="enabled: !!menuSelectedChallenge.id || difficultyFilterMenuOpen"
    bind-toggle__raycastable="menuActive || genreMenuOpen || isSearching || difficultyFilterMenuOpen"
    geometry="primitive: plane; width: 3.4; height: 1.82"
    material="shader: panelShader; ratio: 1.86; opacity: 0"
    animation__opacity="property: components.material.material.uniforms.opacity.value; from: 0; to: 1; dur: 1000; delay: 300; startEvents: startgame"
    animation__midsection="property: components.material.material.uniforms.midSection.value; from: 0; to: 1; dur: 160; startEvents: showDifficultySection; easing: easeOutCubic"
    animation__hidemidsection="property: components.material.material.uniforms.midSection.value; from: 1: to: 0; dur: 160; startEvents: hideDifficultySection, playbuttonclick; easing: easeOutCubic"
    render-order="menu"
    position="0 0 -0.005"></a-entity>

  <a-entity id="mainMenu" bind__visible="!genreMenuOpen && !difficultyFilterMenuOpen && !isMenuOpening">
    <a-entity id="searchResultsContainer" position="0 0 0.001"
      class="menuAnimation"
      bind__menu-slide-animation="isSearching: isSearching; menuSelectedChallengeId: menuSelectedChallenge.id"
      animation__menuleft="property: object3D.position.x; to: -0.79; dur: 200; easing: easeOutCubic; autoplay: false"
      animation__menuright="property: object3D.position.x; from: -0.79; to: 0; dur: 200; easing: easeOutCubic; autoplay: false">

      {{ searchResults() }}

      <a-entity id="soundboxingLink"
        bind__visible="!menuSelectedChallenge.id && !isSearching && !genre"
        position="1.075 -0.492 0.01">
        <a-entity id="soundboxingButton"
          link="href: https://webvr.soundboxing.co/; on: click"
          geometry="primitive: plane; width: 0.38; height: 0.19;"
          material="shader: flat; src: #soundboxingImg"
          animation__mouseenter="property: object3D.position.z; from: 0.01; to: 0.03; startEvents: mouseenter; pauseEvents: mouseleave; easing: easeOutCubic; dur: 150"
          animation__mouseleave="property: object3D.position.z; from: 0.03; to: 0.01; startEvents: mouseleave; pauseEvents: mouseenter; easing: easeOutCubic; dur: 150"
          proxy-event__mouseenter="event: mouseenter; to: CHILDREN; as: show"
          proxy-event__mouseleave="event: mouseleave; to: CHILDREN; as: hide"
          bind__visible-raycastable="menuActive && !menuSelectedChallenge.id && !isSearching && !genre">
          <a-entity id="soundboxing-popup"
            position="0 0.12 0.015"
            mixin="font"
            animation__show="property: components.text.material.uniforms.opacity.value; from: 0; to: 1; startEvents: show; dur: 100"
            animation__hide="property: components.text.material.uniforms.opacity.value; from: 1; to: 0; startEvents: hide; dur: 100"
            render-order="menutext"
            text="value: If you liked this game,\nyou'll love Soundboxing!\nPlay it now instantly.; letterSpacing: 2; opacity: 0; baseline: bottom; width: 0.7; wrapCount: 28; align: center; color:  #fa83d9;"></a-entity>
        </a-entity>
      </a-entity>
    </a-entity>

    <a-entity id="menuDifficultiesGroup" position="0 0.18 0">

      <!-- Top-aligned. -->
      <!-- Uses bind-for and bind-item to render difficulties. -->
      <a-entity id="menuDifficulties"
        bind-for="for: item; in: menuDifficulties; updateInPlace: true; pool: 5"
        bind__visible="!!menuSelectedChallenge.id"
        layout="type: box; columns: 1; marginRow: -0.2; orderAttribute: data-bind-for-key"
        position="0 0.34 0"
        menu-difficulty-select>
        {% raw %}
        <template>
          <!-- Item is a string representing the difficulty. -->
          <a-entity class="difficultyOption" bind-item__data-difficulty="item">
            <a-entity class="difficultyBackground"
                bind-item__active-item="active: menuSelectedChallenge.difficulty === item"
                bind-item__animation__mouseenter="enabled: menuSelectedChallenge.difficulty !== item"
                bind-item__animation__mouseleave="enabled: menuSelectedChallenge.difficulty !== item"
                bind-item__difficulty-background="enabled: menuActive && !!menuSelectedChallenge.id && menuSelectedChallenge.difficulty !== item && !difficultyFilterMenuOpen"
                geometry="primitive: plane; width: 0.4; height: 0.2"
                material="shader: flat; color: #7b3764; transparent: true; opacity: 0.0; src: #difficultyImg"
                position="0 -0.005 0"
                play-sound="event: mouseenter; sound: #hoverSound; volume: 0.03"
                animation__mouseenter="property: components.material.material.opacity; to: 0.3; startEvents: mouseenter; pauseEvents: mouseleave; dur: 75"
                event-set__mouseenter="visible: true"
                animation__mouseleave="property: components.material.material.opacity; to: 0.0; startEvents: mouseleave; pauseEvents: mouseenter; dur: 75"
                event-set__mouseleave="visible: true; _delay: 160"
                render-order="menuitem"></a-entity>
            <a-entity
              class="difficultyText"
              mixin="font"
              bind-item__active-text-color="active: menuSelectedChallenge.difficulty === item"
              bind-item__difficulty-text="difficulty: item"
              active-text-color="color: #fff"
              text="wrapCount: 30; align: center; color: #8d8d8d"
              position="0 -0.057 0.001"
              render-order="menutext"></a-entity>
          </a-entity>
        </template>
      {% endraw %}
      </a-entity>
    </a-entity>

    <!-- Selected challenge info. -->
    <a-entity
      id="menuSelectedChallengePanel"
      bind__visible="!!menuSelectedChallenge.id"
      position="0.8394583182784089 0 0.001">
      <a-entity
        id="menuSelectedChallengeImage"
        bind__menu-selected-challenge-image="selectedChallengeId: menuSelectedChallenge.id"
        geometry="primitive: plane; height: 0.4; width: 0.4"
        material="shader: flat"
        position="0 0.42 0"></a-entity>

      <a-entity id="menuSelectedChallengeInfoContainer" position="0 0.058 0">
        <a-entity
          id="menuSelectedChallengeSongAuthor"
          mixin="font"
          bind__text="value: menuSelectedChallenge.songSubName"
          position="0 0.042 0"
          render-order="menutext"
          text="wrapCount: 27; lineHeight: 40; width: 0.8; align: center; baseline: center; color: {{ COLORS.BLUE }}"></a-entity>
        <a-entity
          id="menuSelectedChallengeSongName"
          mixin="font"
          bind__text="value: menuSelectedChallenge.songName"
          position="0 -0.059 0"
          render-order="menutext"
          text="align: center; color: {{ COLORS.RED }}; wrapCount: 31; baseline: top; lineHeight: 36; width: 1.4"></a-entity>
        <a-entity
          id="menuSelectedChallengeInfo"
          bind__text="value: menuSelectedChallenge.songInfoText"
          mixin="font"
          position="0 -0.42 0"
          render-order="menutext"
          text="align: center; color: #989898; wrapCount: 30; lineHeight: 72; width: 0.9; baseline: bottom"></a-entity>
      </a-entity>

      <a-entity
        id="playButton"
        bind__visible-raycastable="menuActive && !!menuSelectedChallenge.id && !genreMenuOpen && !difficultyFilterMenuOpen"
        geometry="primitive: plane; width: 0.7; height: 0.25"
        play-sound="event: mouseenter; sound: #hoverSound; volume: 0.03"
        play-sound__click="event: click; sound: #confirmSound; volume: 0.25"
        position="0 -0.561 0"
        proxy-event="event: click; to: a-scene; as: playbuttonclick"
        material="shader: panelShader; brightness: 0.7; transparent: true; midSection: 0; ratio: 2.8; borderRadius: 0.6; borderWidth: 0.08"
        render-order="menubutton"
        animation__mouseenter1="property: components.material.material.uniforms.active.value; from: 0; to: 1; startEvents: mouseenter; pauseEvents: mouseleave; dur: 100"
        animation__mouseleave1="property: components.material.material.uniforms.active.value; from: 1; to: 0; startEvents: mouseleave; pauseEvents: mouseenter; dur: 100"
        animation__mouseenter2="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; startEvents: mouseenter; pauseEvents: mouseleave; dur: 100"
        animation__mouseleave2="property: scale; to: 1 1 1; from: 1.1 1.1 1.1; startEvents: mouseleave; pauseEvents: mouseenter; dur: 100">
          <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 15; value: PLAY" position="0 -0.085 0.01"></a-entity>
        </a-entity>
    </a-entity>

    <a-entity
      id="searchError"
      mixin="font"
      bind__visible="search.hasError"
      render-order="menuText"
      text="align: center; value: Sorry, there was an issue fetching search results. Please try again."
      position="0 0 0.01"></a-entity>
  </a-entity>

  <a-entity
    id="genreMenu"
    bind-for="for: genre; in: genres; updateInPlace: true; key: name"
    bind__visible="genreMenuOpen"
    layout="type: box; columns: 6; marginRow: 0.4; marginColumn: 0.4; align: center"
    search-genre
    position="0 0 0.05">
    <template>
      <a-entity class="genre" bind-item__data-genre="item">
        <a-entity
          mixin="slice"
          slice9="opacity: 0.9; width: 0.35; left: 70; top: 70; height: 0.35; padding: 0.07"
          animation__mouseenter2="property: scale; from: 1 1 1; to: 1.03 1.03 1.03; startEvents: mouseenter; pauseEvents: mouseleave; easing: easeOutCubic; dur: 150"
          animation__mouseleave2="property: scale; from: 1.03 1.03 1.03; to: 1 1 1; startEvents: mouseleave; pauseEvents: mouseenter; easing: easeOutCubic; dur: 150"
          proxy-event__enter="event: mouseenter; to: CHILDREN; captureBubbles: true"
          proxy-event__leave="event: mouseleave; to: CHILDREN; captureBubbles: true"
          play-sound__click="event: click; sound: #confirmSound; volume: 0.1"
          raycaster-target="bindToggle: genreMenuOpen; width: 0.35; height: 0.35"
          render-order__nonrecursive="menubutton">
          <a-entity
            mixin="font"
            bind-item__text="value: item.name"
            text="align: center; width: 1.1; color: #888"
            animation__mouseenter="property: components.text.material.uniforms.color.value; from: #888; to: #FFF; type: color; startEvents: mouseenter; pauseEvents: mouseleave; easing: easeOutCubic; dur: 150"
            animation__mouseleave="property: components.text.material.uniforms.color.value; from: #FFF; to: #888; type: color; startEvents: mouseleave; pauseEvents: mouseenter; easing: easeOutCubic; dur: 150"
            render-order="menutext"
            position="0 -0.16 0.001"></a-entity>
          <a-entity
            class="genreIcon"
            bind-item__atlas-uvs="totalColumns: 6; totalRows: 3; row: item.row; column: item.column"
            geometry="primitive: plane; width: 0.22; height: 0.22; buffer: false; skipCache: true"
            position="0 0.04 0.002"
            material="shader: flat; src: #genresImg; transparent: true; color: #888"
            render-order="menutext"
            animation__mouseenter="property: components.material.material.color; type: color; from: #888; to: #FFF; startEvents: mouseenter; pauseEvents: mouseleave; easing: easeOutCubic; dur: 150"
            animation__mouseleave="property: components.material.material.color; type: color; from: #FAFAFA; to: #888; startEvents: mouseleave; pauseEvents: mouseenter; easing: easeOutCubic; dur: 150"></a-entity>
        </a-entity>
      </a-entity>
    </template>
  </a-entity>

  <require path="templates/difficultyMenu.html"></require>
</a-entity>

<a-entity
  id="keyboard"
  bind__super-keyboard="{% if not DEBUG_KEYBOARD %}hand: activeHand === 'left' && '#leftHand' || '#rightHand'; {% endif %}show: isSearching"
  super-keyboard="label: Search From Over 15000 Songs; inputColor: #fff; labelColor: {{ COLORS.WHITE }}; width: 1.5; hand: {{ DEBUG_KEYBOARD and '#mouseCursor' or '#rightHand' }}; imagePath: assets/img/keyboard/; font: assets/fonts/Viga-Regular.json; align: center; model: superkeyboard; keyColor: #fff; injectToRaycasterObjects: false; filters: allupper; keyHoverColor: #fff"
  position="0.58 1.2 -1.95"
  keyboard-raycastable="condition: isSearching"
  search
  proxy-event__dismiss="event: superkeyboarddismiss; to: a-scene; as: keyboardclose"
  proxy-event__accept="event: superkeyboardinput; to: a-scene; as: keyboardclose"
  render-order="menubutton"
  render-order-recursive>
</a-entity>

<a-entity
  id="backButton"
  mixin="bigMenuButton"
  bind__visible-raycastable="genreMenuOpen || isSearching || difficultyFilterMenuOpen"
  position="0 2.35 -1.96"
  play-sound__hover="event: mouseenter; sound: #hoverSound; volume: 0.1"
  proxy-event__difficultyfilter="event: click; to: a-scene; as: difficultyfiltermenuclose"
  proxy-event__genres="event: click; to: a-scene; as: genremenuclose"
  proxy-event__searching="event: click; to: a-scene; as: keyboardclose">
  <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 20; value: BACK" position="0 -0.07 0.01"></a-entity>
</a-entity>

<a-entity
  id="searchButtons"
  position="-0.85 2.35 -1.96"
  animation__position="property: object3D.position.z; to: -1.9; dur: 1500; easing: easeInOutCubic; delay: 300; startEvents: startgame"
  proxy-event="event: startgame; to: #searchButton">
  <a-entity id="searchButton"
    mixin="bigMenuButton"
    bind__visible-raycastable="menuActive && !genreMenuOpen && !isSearching && !search.query && !difficultyFilterMenuOpen"
    material="opacity: 0"
    animation__opacity="property: components.material.material.uniforms.opacity.value; from: 0; to: 1; dur: 1000; delay: 300; startEvents: startgame"
    play-sound__hover="event: mouseenter; sound: #hoverSound; volume: 0.1"
    proxy-event="event: click; to: a-scene; as: keyboardopen">
    <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 20; value: SEARCH" bind__visible="!isMenuOpening" position="0 -0.07 0.01"></a-entity>
  </a-entity>

  <a-entity id="searchClearButton"
    mixin="bigMenuButton"
    bind__visible-raycastable="menuActive && !!search.query && !isSearching && !genreMenuOpen && !difficultyFilterMenuOpen"
    play-sound__hover="event: mouseenter; sound: #hoverSound; volume: 0.1"
    play-sound__click="event: click; sound: #clearSound"
    proxy-event="event: click; to: a-scene; as: searchclear">
    <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 20; value: CLEAR SEARCH" position="0 -0.07 0.01"></a-entity>
  </a-entity>

  <a-entity
    id="searchText"
    mixin="font"
    bind__text-uppercase="value: search.query"
    bind__visible="!!search.query && !isSearching && !genreMenuOpen && !difficultyFilterMenuOpen"
    text="align: center; color: {{ COLORS.RED }}; wrapCount: 20"
    position="0 0.1 0.035"></a-entity>
</a-entity>

<a-entity
  id="difficultyFilter"
  position="0 2.35 -1.96"
  animation__position="property: object3D.position.z; to: -1.9; dur: 1500; easing: easeInOutCubic; delay: 300; startEvents: startgame"
  proxy-event="event: startgame; to: #difficultyButton">
  <a-entity id="difficultyButton"
    mixin="bigMenuButton"
    material="opacity: 0"
    bind__visible-raycastable="menuActive && !genreMenuOpen && !isSearching && !difficultyFilterMenuOpen"
    animation__opacity="property: components.material.material.uniforms.opacity.value; from: 0; to: 1; dur: 1000; delay: 300; startEvents: startgame"
    play-sound__hover="event: mouseenter; sound: #hoverSound; volume: 0.1"
    proxy-event="event: click; to: a-scene; as: difficultyfiltermenuopen">
    <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 20; value: DIFFICULTY" bind__visible="!isMenuOpening" position="0 -0.07 0.01"></a-entity>
  </a-entity>

  <a-entity
    id="difficultyFilterText"
    mixin="font"
    bind__difficulty-text="difficulty: difficultyFilter"
    bind__visible="difficultyFilter !== 'All' && !genreMenuOpen && !difficultyFilterMenuOpen"
    text="align: center; color: {{ COLORS.RED }}; wrapCount: 20"
    position="0 0.1 0.035"></a-entity>
</a-entity>

<a-entity
  id="genreButtons"
  position="0.85 2.35 -1.96"
  animation__position="property: object3D.position.z; to: -1.9; dur: 1500; easing: easeInOutCubic; delay: 300; startEvents: startgame"
  proxy-event="event: startgame; to: #genreButton">
  <a-entity id="genreButton"
    mixin="bigMenuButton"
    bind__visible-raycastable="menuActive && !genreMenuOpen && !isSearching && !genre && !difficultyFilterMenuOpen"
    material="opacity: 0"
    animation__opacity="property: components.material.material.uniforms.opacity.value; from: 0; to: 1; dur: 1000; delay: 300; startEvents: startgame"
    play-sound__hover="event: mouseenter; sound: #hoverSound; volume: 0.1"
    proxy-event="event: click; to: a-scene; as: genremenuopen">
    <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 20; value: GENRES" bind__visible="!isMenuOpening" position="0 -0.07 0.01"></a-entity>
  </a-entity>

  <a-entity id="clearGenreButton"
    mixin="bigMenuButton"
    bind__visible-raycastable="menuActive && !!genre && !isSearching && !difficultyFilterMenuOpen"
    play-sound__hover="event: mouseenter; sound: #hoverSound; volume: 0.1"
    play-sound__click="event: click; sound: #clearSound"
    proxy-event="event: click; to: a-scene; as: searchclear">
    <a-entity mixin="font" text="align: center; color: #FFF; wrapCount: 20; value: CLEAR GENRE" position="0 -0.07 0.01"></a-entity>
  </a-entity>

  <a-entity
    id="genreText"
    mixin="font"
    bind__text-uppercase="value: genre"
    bind__visible="!!genre && !isSearching"
    text="align: center; color: {{ COLORS.RED }}; wrapCount: 20"
    position="0 0.1 0.035"></a-entity>
</a-entity>
